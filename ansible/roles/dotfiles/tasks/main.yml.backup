---
- name: Determine package list
  ansible.builtin.set_fact:
    dotfiles_packages:
      - git
      - curl
      - zsh
      - less
      - vim

- name: Check if sudo is available
  ansible.builtin.command: command -v sudo
  register: sudo_check
  changed_when: false
  failed_when: false
  when: install_deps | bool

- name: Install prerequisites
  ansible.builtin.package:
    name: "{{ dotfiles_packages }}"
    state: present
  when: install_deps | bool
  become: "{{ ansible_user_id != 'root' and sudo_check.rc == 0 }}"
  ignore_errors: true

- name: Ensure dotfiles directory exists
  ansible.builtin.file:
    path: "{{ dotfiles_dir }}"
    state: directory
    mode: "0755"

- name: Clone or update dotfiles repo when repo is provided
  ansible.builtin.git:
    repo: "{{ dotfiles_repo }}"
    dest: "{{ dotfiles_dir }}"
    version: HEAD
    update: true
  when: dotfiles_repo | length > 0

- name: Warn if repo URL not provided and directory may be missing
  ansible.builtin.debug:
    msg: "dotfiles_repo not set; expecting existing files in {{ dotfiles_dir }}"
  when: dotfiles_repo | length == 0

- name: Stat existing .zshrc
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.zshrc"
    follow: false
  register: zshrc_stat

- name: Backup existing .zshrc if regular file
  ansible.builtin.command: >-
    mv "{{ ansible_env.HOME }}/.zshrc" "{{ ansible_env.HOME }}/.zshrc.bak.{{ lookup('pipe','date +%Y%m%d%H%M%S') }}"
  when: zshrc_stat.stat.exists and not zshrc_stat.stat.islnk

- name: Check if dotfiles zshrc exists
  ansible.builtin.stat:
    path: "{{ dotfiles_dir }}/zsh/.zshrc"
  register: repo_zshrc_stat

- name: Symlink .zshrc to repo version
  ansible.builtin.file:
    src: "{{ dotfiles_dir }}/zsh/.zshrc"
    dest: "{{ ansible_env.HOME }}/.zshrc"
    state: link
  when: repo_zshrc_stat.stat.exists

- name: Warn if dotfiles zshrc missing
  ansible.builtin.debug:
    msg: "WARNING: {{ dotfiles_dir }}/zsh/.zshrc not found; skipping symlink"
  when: not repo_zshrc_stat.stat.exists

- name: Stat .zshrc.local
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.zshrc.local"
  register: zshrc_local_stat

- name: Ensure .zshrc.local exists from template if missing
  ansible.builtin.template:
    src: zshrc.local.j2
    dest: "{{ ansible_env.HOME }}/.zshrc.local"
    mode: "0644"
  when: not zshrc_local_stat.stat.exists

- name: Stat Oh My Zsh directory
  ansible.builtin.stat:
    path: "{{ ansible_env.HOME }}/.oh-my-zsh"
  register: omz_stat

- name: Install Oh My Zsh when missing
  block:
    - name: Create temporary file for installer
      ansible.builtin.tempfile:
        state: file
      register: omz_tmp

    - name: Download Oh My Zsh installer
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        dest: "{{ omz_tmp.path }}"
        mode: "0700"

    - name: Run Oh My Zsh installer non-interactively
      ansible.builtin.command: >-
        env RUNZSH=no CHSH=no KEEP_ZSHRC=yes sh {{ omz_tmp.path }}
      args:
        creates: "{{ ansible_env.HOME }}/.oh-my-zsh"
  when: not omz_stat.stat.exists
  always:
    - name: Remove temporary installer file
      ansible.builtin.file:
        path: "{{ omz_tmp.path | default('') }}"
        state: absent
      when: omz_tmp is defined

- name: Determine current shell
  ansible.builtin.command: "getent passwd {{ ansible_user_id }}"
  register: passwd_entry
  changed_when: false
  failed_when: false

- name: Discover zsh path
  ansible.builtin.command: "command -v zsh"
  register: zsh_path
  changed_when: false
  failed_when: false

- name: Set default shell to zsh
  ansible.builtin.command: "chsh -s {{ zsh_path.stdout }} {{ ansible_user_id }}"
  when:
    - set_default_shell | bool
    - passwd_entry.stdout is not regex('\/zsh$')
    - zsh_path.rc == 0
    - zsh_path.stdout | length > 0
  register: chsh_result
  changed_when: chsh_result.rc == 0
  failed_when: false

- name: Warn if default shell change failed
  ansible.builtin.debug:
    msg: "Could not change default shell automatically. Run: chsh -s {{ zsh_path.stdout }}"
  when:
    - set_default_shell | bool
    - chsh_result is defined
    - chsh_result.rc != 0
    - zsh_path.stdout | length > 0
