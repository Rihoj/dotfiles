# Dotfiles

Personal dotfiles managed with Ansible for consistency across machines.

## The One True Way

```bash
# Clone this repo
git clone <your-repo-url> ~/.dotfiles
cd ~/.dotfiles

# Run the bootstrap (installs Ansible if needed, then provisions)
./bootstrap.sh
```

That's it. Everything else is optional flags.

## Optional Flags

```bash
./bootstrap.sh --repo <url>        # Clone from remote instead of using local repo
./bootstrap.sh --no-install-deps   # Skip package installation
./bootstrap.sh --no-chsh           # Don't change default shell to zsh
./bootstrap.sh --dry-run           # See what would be done without making changes
```

## What Gets Managed

- **Repo files**: All files in this repo are the canonical source of truth
- **~/.zshrc**: Symlinked to repo. Overwritten on every run.
- **~/.zshrc.local**: Created once from template. NEVER touched again. This is YOUR file.

## Platform Support

Tested on:
- Linux (Debian, Ubuntu, RHEL, Fedora, Arch)
- macOS (with some limitations on shell detection)

Requirements:
- Bash 4.0+
- Python 3.6+
- Git

## Ownership Contract

- **Repo owns**: .zshrc, all zsh modules, aliases, environment setup
- **You own**: ~/.zshrc.local for machine-specific config, secrets, local paths

## Safety Features

- **Backups**: Existing files backed up to `~/.dotfiles-backups/` before replacement
- **Dry-run**: Use `--dry-run` to see changes without applying them
- **Idempotent**: Safe to re-run any time
- **Tags**: Run specific parts with `ansible-playbook ... --tags config,omz`

## Direct Ansible Usage

If you already have Ansible installed:

```bash
ansible-playbook -i localhost, -c local ansible/playbook.yml
```

Use extra vars as needed:
```bash
ansible-playbook ... -e dotfiles_repo=<url> -e install_deps=false
```

Available tags: `packages`, `repo`, `config`, `omz`, `shell`

## Rollback

Backups are timestamped in `~/.dotfiles-backups/`. To restore:

```bash
cp ~/.dotfiles-backups/zshrc.<timestamp> ~/.zshrc
```

## Migrating Existing Dotfiles

### Quick Start

```bash
cd ~/.dotfiles

# 1. Run bootstrap to create the structure
./bootstrap.sh

# 2. Back up your current .zshrc
cp ~/.zshrc ~/zshrc.backup

# 3. Now add YOUR content to the generated modules

# 3. Split your config into modules:
#    - Environment/PATH: zsh/zshrc.d/00-env.zsh
#    - Aliases: zsh/zshrc.d/20-aliases.zsh
#    - Functions: zsh/zshrc.d/30-functions.zsh
#    - Prompts/themes: zsh/zshrc.d/40-prompt.zsh
#    - Machine-specific: ~/.zshrc.local (NOT in repo)

# 4. The main .zshrc should be minimal (just loads modules)
# Look at zsh/.zshrc in this repo for the loader template

# 5. Test before committing
./bootstrap.sh --dry-run   # see what would change
exec zsh                    # test loading

# 6. If it works, commit
git add zsh/
git commit -m "Add existing zsh config"
```

### File Organization Guide

```
~/.dotfiles/
├── zsh/
│   ├── .zshrc              # Thin loader (generated by bootstrap)
│   └── zshrc.d/
│       ├── 00-env.zsh      # PATH, EDITOR, exports
│       ├── 10-omz.zsh      # Oh My Zsh config (theme, plugins)
│       ├── 20-aliases.zsh  # Command aliases
│       ├── 30-functions.zsh # Shell functions
│       └── 40-prompt.zsh   # Custom prompt (if not using OMZ theme)
├── git/                    # Git configuration (optional)
│   └── .gitconfig          # Git settings, aliases, includes
├── vim/                    # Vim configuration (optional)
│   └── .vimrc              # Vim settings
├── shell/                  # POSIX shell fragments (optional)
│   └── .bashrc             # Bash config (for portability)
├── bin/                    # Your scripts (auto-added to PATH)
└── npm/                    # NPM configuration (optional)
    └── .npmrc
```

### What Goes Where

**In the repo (committed):**
- Universal aliases: `zsh/zshrc.d/20-aliases.zsh`
- Portable functions: `zsh/zshrc.d/30-functions.zsh`
- Environment setup: `zsh/zshrc.d/00-env.zsh`
- Custom OMZ plugins: `zsh/omz-custom/plugins/`
- Utilities: `bin/`

**NOT in repo (stays local):**
- Machine-specific PATHs: `~/.zshrc.local`
- API keys/tokens: `~/.zshrc.local`
- Work-only config: `~/.zshrc.local`
- SSH keys: `~/.ssh/` (never commit)
- GPG keys: `~/.gnupg/` (never commit)

### Additional Config Files to Migrate (Optional)

Beyond zsh, you may want to track these under version control:

**Git**
```bash
mkdir -p ~/.dotfiles/git
cp ~/.gitconfig ~/.dotfiles/git/.gitconfig
```
Then symlink or update Ansible playbook to manage it.

**Vim**
```bash
mkdir -p ~/.dotfiles/vim
cp ~/.vimrc ~/.dotfiles/vim/.vimrc
```

**Bash** (for when using bash)
```bash
mkdir -p ~/.dotfiles/shell
cp ~/.bashrc ~/.dotfiles/shell/.bashrc
```

**NPM, Serverless, etc.** (optional)
```bash
mkdir -p ~/.dotfiles/npm
cp ~/.npmrc ~/.dotfiles/npm/.npmrc
```

**⚠️ DO NOT COMMIT:**
- `~/.ssh/` - Private keys
- `~/.gnupg/` - GPG keys  
- `~/.aws/` - AWS credentials
- `~/.docker/` - Docker auth
- History files (`.bash_history`, `.zsh_history`, `.viminfo`)
- IDE directories (`.vscode*`, `.java`)

### Migration Checklist

- [ ] Back up current .zshrc: `cp ~/.zshrc ~/zshrc.backup`
- [ ] Split config into zsh/zshrc.d/ modules
- [ ] Move machine-specific config to ~/.zshrc.local
- [ ] Migrate additional configs (git, vim, npm, etc.)
- [ ] Add custom scripts to bin/
- [ ] Test with `./bootstrap.sh --dry-run`
- [ ] Verify modules load: `zsh -c 'echo $DOTFILES_DIR'`
- [ ] Commit: `git add zsh/ git/ bin/ && git commit -m "Migrate dotfiles"`
- [ ] Push to remote: `git push -u origin main`

## Legacy Scripts

- `setup-dotfiles.sh`: Old bash-only bootstrap. **Deprecated.** Use `bootstrap.sh` instead.

## Update Utilities

These scripts help keep your dotfiles up to date across machines and make commands available globally.

- **[bin/dotfiles-check-updates.sh](bin/dotfiles-check-updates.sh):** Auto-checks for repo updates on shell startup, every N days.
    - Env: `ZSH_DOTFILES_UPDATE_FREQ` (default: 7)
    - Loaded by [zsh/zshrc.d/05-dotfiles-updates.zsh](zsh/zshrc.d/05-dotfiles-updates.zsh)

- **[bin/dotfiles-pull-updates.sh](bin/dotfiles-pull-updates.sh):** Manual updater.
    - Check only: `dotfiles-pull-updates --check-only`
    - Pull and notify reload: `dotfiles-pull-updates`
    - Uses your upstream tracking branch (`@{u}`), not hardcoded origin/main

- **[bin/dotfiles-link-bin.sh](bin/dotfiles-link-bin.sh):** Symlinks scripts in `bin/` to `~/.local/bin`.
    - Run once: `~/.dotfiles/bin/dotfiles-link-bin.sh`
    - Ensure PATH includes `~/.local/bin`:

```bash
export PATH="$HOME/.local/bin:$PATH"
```

### Behavior
- Non-blocking: update checks run in the background during shell startup.
- Safe defaults: does nothing if the repo isn’t a git clone.
- Clear prompts: shows a short notice when updates are available.

### Migration Mode (Optional)
By default, provisioning will NOT copy existing home dotfiles into the repo.
To explicitly migrate legacy dotfiles from `~` into this repo during provisioning, set:

```bash
MIGRATE_EXISTING_DOTFILES=true ./bootstrap.sh
```

Or pass via Ansible extra vars:

```bash
ansible-playbook -i localhost, -c local ansible/playbook.yml -e migrate_existing_dotfiles=true
```

This gates home→repo copy/backup/removal to avoid mutating a curated repo on subsequent runs.
