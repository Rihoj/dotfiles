# Dotfiles Repository Instructions

## 1. Overview

This repository manages shell and environment configuration using a dotfiles pattern. All configuration lives in version control and is projected into the home directory via symlinks. The goals are:

- Consistent developer experience across machines
- Portability without assuming a specific Linux distribution
- Reproducibility and idempotent setup
- Safety: no secrets committed, machine-specific overrides are local only
- Prefer POSIX-compatible shell behavior

Use this repo to own your configuration. External tools and frameworks are integrated, but they do not control the configuration files in your home directory.

## 2. Repository Structure

A typical layout is shown below. Names can vary slightly, but responsibilities should remain clear.

```
.
├─ install.sh                  # Bootstrap entrypoint for a new machine (POSIX sh)
├─ setup-dotfiles.sh           # Alternate or legacy bootstrap script if present
├─ bin/                        # Portable executables added to PATH
├─ scripts/                    # Helper scripts used by install/maintenance
├─ shell/                      # POSIX shell fragments (profile.d-style), env, path
├─ zsh/                        # Zsh-specific config: rc fragments, prompt, aliases, plugins
├─ git/                        # Git config (global), includes, templates
├─ tmux/                       # tmux configuration
├─ config/                     # XDG-config tree (e.g., nvim, starship, etc.)
└─ README.md                   # Optional human-facing summary
```

Responsibilities:

- `install.sh`: Creates symlinks, ensures idempotency, sets XDG locations, and integrates Zsh and Oh My Zsh (OMZ) without letting OMZ own the config.
- `bin/`: First-class scripts you control. Keep them portable and dependency-light.
- `shell/`: Environment setup for all shells. Prefer POSIX sh for maximum portability.
- `zsh/`: Zsh-only config you source from `.zshrc`. Keep OMZ-specific parts isolated and minimal.
- `git/`: Global Git configuration. Use `includeIf` and local includes for machine-specific settings.
- `config/`: Files under `$XDG_CONFIG_HOME` (typically `~/.config`). Symlink targets should mirror this tree.

### Why symlinks

Symlinks project files from this repo into the home directory without copying. Benefits:

- Single source of truth in version control
- Atomic updates by switching repo revision
- Easy rollback and auditing
- Idempotent installer can re-run safely

Use absolute symlinks for clarity. Create parent directories first, then link. Example helper:

```sh
link() {
  src=$1
  dest=$2
  mkdir -p "$(dirname "$dest")"
  ln -sfn "$src" "$dest"
}

DOTFILES=${DOTFILES:-"$HOME/.dotfiles"}
link "$DOTFILES/zsh/.zshrc" "$HOME/.zshrc"
link "$DOTFILES/config/nvim" "$HOME/.config/nvim"
```

## 3. Bootstrapping a New Machine

Prerequisites: `git`, `ln`, `mkdir`, `sh`, and basic network tools (`curl` or `wget`). No distribution-specific package manager is assumed.

1. Clone the repository:

```sh
git clone https://example.com/your/dotfiles.git "$HOME/.dotfiles"
cd "$HOME/.dotfiles"
```

2. Run the installer (POSIX sh):

```sh
sh install.sh
```

If the repository provides `setup-dotfiles.sh` instead, run:

```sh
sh setup-dotfiles.sh
```

The installer should:

- Create required directories (e.g., `~/.config`)
- Symlink repo files into the home directory
- Detect Zsh and install OMZ if missing, without allowing OMZ to modify `.zshrc`
- Avoid interactive prompts by default; support a flag or environment variable for confirmations if needed
- Be safe to re-run any time (idempotent)

## 4. Zsh and Oh My Zsh Integration

Zsh is the primary interactive shell. OMZ can be installed as a library of functions and plugins, but configuration remains owned by this repo.

Guidelines:

- `.zshrc` in the home directory is a symlink to a file in this repo
- OMZ does not write to or manage `.zshrc`
- Source OMZ core once, then load repo-managed prompt, aliases, and plugins
- Disable OMZ auto-update if you prefer deterministic behavior

Example `.zshrc` ownership pattern:

```sh
# Managed by dotfiles repo
DOTFILES=${DOTFILES:-"$HOME/.dotfiles"}
export ZSH="$HOME/.oh-my-zsh"
export ZSH_CUSTOM="$DOTFILES/zsh/omz-custom"
export DISABLE_AUTO_UPDATE="true"

# Optional: keep OMZ theme off; use repo prompt instead
ZSH_THEME=""
plugins=(git)

# Load OMZ core
[ -f "$ZSH/oh-my-zsh.sh" ] && . "$ZSH/oh-my-zsh.sh"

# Load repo-managed modules after OMZ
[ -f "$DOTFILES/zsh/prompt.zsh" ] && . "$DOTFILES/zsh/prompt.zsh"
[ -f "$DOTFILES/zsh/aliases.zsh" ] && . "$DOTFILES/zsh/aliases.zsh"
[ -f "$DOTFILES/zsh/plugins.zsh" ] && . "$DOTFILES/zsh/plugins.zsh"

# Local overrides last (see next section)
[ -f "$HOME/.zshrc.local" ] && . "$HOME/.zshrc.local"
```

This ensures OMZ is a dependency you load, not a configuration owner.

## 5. Local Overrides and Machine-Specific Configuration

Machine-specific settings belong outside the repo. Use an opt-in local file sourced at the end of `.zshrc`:

```sh
# At the end of .zshrc
[ -f "$HOME/.zshrc.local" ] && . "$HOME/.zshrc.local"
```

Recommendations:

- Add `.zshrc.local` to `.gitignore` so it is never committed
- Use it for secrets, tokens, proprietary paths, or per-machine PATH adjustments
- Keep it minimal and self-contained; avoid redefining repo-managed functions unless necessary

Example `.zshrc.local`:

```sh
# Example: per-machine additions
export PATH="$HOME/.local/bin:$PATH"
export EDITOR="nvim"

# Example: enable optional features guarded in repo config
export DOTFILES_ENABLE_FZF=1
```

For other tools (Git, SSH, etc.), prefer local include files:

- Git: use `~/.gitconfig.local` included via `includeIf` with directory conditions
- SSH: use `~/.ssh/config` and separate host-specific includes kept out of this repo

## 6. Updating and Maintaining the Dotfiles

Evolve the repo safely with these practices:

- Idempotent changes: installers and linkers must be safe to re-run
- Backward compatibility: avoid breaking existing symlink targets or filenames; deprecate gradually
- Additive migrations: introduce new files alongside old ones, then remove after a transition period
- Guards and feature flags: use environment variables to enable optional features
- Test on at least two machines before merging
- Avoid distribution-specific commands in the installer; detect tools at runtime

Examples:

```sh
# Guard optional feature by env var
if [ "${DOTFILES_ENABLE_FZF:-0}" = "1" ]; then
  # Source fzf config if available
  [ -f "$DOTFILES/shell/fzf.sh" ] && . "$DOTFILES/shell/fzf.sh"
fi

# Safe detection and install of OMZ, without touching .zshrc
if [ ! -d "$HOME/.oh-my-zsh" ]; then
  # Non-interactive install; verify curl/wget availability
  if command -v curl >/dev/null 2>&1; then
    sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || true
  elif command -v wget >/dev/null 2>&1; then
    sh -c "$(wget -qO- https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended || true
  fi
fi
```

Maintenance guidelines:

- Document changes that require user action
- Prefer XDG locations (`$XDG_CONFIG_HOME`) for new tools
- Vendor critical scripts if remote availability is a concern
- Keep shell fragments POSIX-compliant unless they are explicitly Zsh-only
- Periodically check for broken symlinks and stale files

## 7. Common Pitfalls and Best Practices

Pitfalls:

- Letting OMZ overwrite `.zshrc` during interactive install; fix by re-symlinking and ensuring `.zshrc` is repo-owned
- Using relative symlinks that break when the repo moves; prefer absolute paths
- Mixing Bash-only syntax in POSIX sh installers; keep installers POSIX-compliant
- Committing secrets or machine-specific tokens; keep them in local files and out of version control
- Breaking PATH order by inserting before core system paths; be deliberate with PATH precedence
- Assuming a specific distribution or package manager in bootstrap

Best practices:

- Idempotent installer: re-run should converge to the same state
- Small, reviewable changes: prefer incremental updates
- Feature flags: gate optional integrations by environment variables
- XDG-first: write config under `~/.config` unless a tool requires a dotfile in `$HOME`
- Health checks: verify symlinks and expected files exist after install

Check symlinks example:

```sh
# List broken links under HOME
find "$HOME" -xtype l -print
```

Recovery example:

```sh
# Force re-link a file
ln -sfn "$DOTFILES/zsh/.zshrc" "$HOME/.zshrc"
```

Security note: never commit secrets, tokens, or personal data. Use local overrides and secret managers (OS keyring, pass, gopass, or similar) outside of this repo.
